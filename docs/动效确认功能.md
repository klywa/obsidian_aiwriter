# 动效确认功能 - 删除Session和清空历史

## 需求背景

用户希望在执行删除session和清空历史等危险操作时有确认机制，但不要使用弹窗（`window.confirm`），而是通过动效来确认。

## 设计方案

采用**两步点击确认**机制：
1. **第一次点击**：按钮进入"待确认"状态，显示动效提示
2. **第二次点击**：真正执行删除/清空操作
3. **点击外部**：取消确认状态，恢复正常

### 优势
- ✅ 无需弹窗，不打断用户流程
- ✅ 视觉反馈明确（颜色、大小、动画）
- ✅ 可以通过点击外部快速取消
- ✅ 符合现代UI交互习惯

## 实现细节

### 1. 状态管理

添加两个新的状态：

```typescript
const [deletingSessionId, setDeletingSessionId] = useState<string | null>(null);
const [clearHistoryConfirm, setClearHistoryConfirm] = useState(false);
```

**说明：**
- `deletingSessionId`：记录哪个session正在等待删除确认
- `clearHistoryConfirm`：记录清空历史按钮是否在等待确认状态

### 2. 删除Session功能改造

#### 修改函数签名

```typescript
const deleteSession = (sessionId: string, confirmed: boolean = false) => {
    // 第一次点击：进入确认状态
    if (!confirmed) {
        setDeletingSessionId(sessionId);
        return;
    }
    
    // 第二次点击：真正删除
    setDeletingSessionId(null);
    
    // ... 原有的删除逻辑
};
```

#### UI动效设计

```typescript
<div
    onClick={(e) => {
        e.stopPropagation();
        deleteSession(session.id, deletingSessionId === session.id);
    }}
    style={{ 
        cursor: 'pointer', 
        opacity: deletingSessionId === session.id ? 1 : 0.7,
        color: deletingSessionId === session.id ? 'var(--text-error)' : 'inherit',
        transform: deletingSessionId === session.id ? 'scale(1.2)' : 'scale(1)',
        transition: 'all 0.2s ease',
        display: 'flex',
        alignItems: 'center',
        gap: '2px'
    }}
    title={deletingSessionId === session.id ? '再次点击确认删除' : '删除对话'}
>
    <CloseIcon size={deletingSessionId === session.id ? 14 : 12} />
</div>
```

**动效说明：**
- **正常状态**：opacity: 0.7，灰色，size: 12
- **确认状态**：opacity: 1，红色，size: 14，scale: 1.2
- **过渡动画**：0.2s ease，流畅自然

### 3. 清空历史功能改造

#### 修改函数签名

```typescript
const handleClearHistory = (confirmed: boolean = false) => {
    // 第一次点击：进入确认状态
    if (!confirmed) {
        setClearHistoryConfirm(true);
        return;
    }
    
    // 第二次点击：真正清空
    setClearHistoryConfirm(false);
    
    // ... 原有的清空逻辑
};
```

#### UI动效设计

```typescript
<button 
    className="clickable-icon"
    onClick={() => handleClearHistory(clearHistoryConfirm)}
    style={{ 
        padding: '6px', 
        background: clearHistoryConfirm ? 'var(--background-modifier-error)' : 'transparent', 
        border: clearHistoryConfirm ? '1px solid var(--text-error)' : 'none',
        borderRadius: '6px',
        color: clearHistoryConfirm ? 'var(--text-error)' : 'var(--text-muted)',
        cursor: 'pointer',
        transform: clearHistoryConfirm ? 'scale(1.1)' : 'scale(1)',
        transition: 'all 0.2s ease'
    }}
    title={clearHistoryConfirm ? '再次点击确认清空' : '清空历史'}
>
    <TrashIcon size={clearHistoryConfirm ? 18 : 16} />
</button>
```

**动效说明：**
- **正常状态**：透明背景，灰色图标，size: 16
- **确认状态**：红色背景，红色边框，size: 18，scale: 1.1
- **过渡动画**：0.2s ease

### 4. 点击外部取消确认

在已有的点击外部监听器中添加取消逻辑：

```typescript
useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
        // ... 其他逻辑
        
        // 点击外部取消删除session确认
        setDeletingSessionId(null);
        // 点击外部取消清空历史确认
        setClearHistoryConfirm(false);
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
        document.removeEventListener('mousedown', handleClickOutside);
    };
}, [editingMessageId]);
```

## 交互流程

### 删除Session

```
┌─────────────────────────────────────────────────────┐
│ 第一次点击删除按钮                                    │
│  ↓                                                  │
│ 按钮变红色、放大、图标变大                           │
│ setDeletingSessionId(sessionId)                    │
│  ↓                                                  │
│ 用户有两个选择：                                     │
│  1. 再次点击 → 执行删除 → 恢复状态                   │
│  2. 点击外部 → 取消确认 → 恢复状态                   │
└─────────────────────────────────────────────────────┘
```

### 清空历史

```
┌─────────────────────────────────────────────────────┐
│ 第一次点击清空按钮                                    │
│  ↓                                                  │
│ 按钮变红色背景、放大、图标变大                        │
│ setClearHistoryConfirm(true)                       │
│  ↓                                                  │
│ 用户有两个选择：                                     │
│  1. 再次点击 → 执行清空 → 恢复状态                   │
│  2. 点击外部 → 取消确认 → 恢复状态                   │
└─────────────────────────────────────────────────────┘
```

## 视觉效果对比

### 删除Session按钮

| 状态 | opacity | color | size | scale | tooltip |
|------|---------|-------|------|-------|---------|
| **正常** | 0.7 | inherit | 12 | 1.0 | "删除对话" |
| **确认** | 1.0 | red | 14 | 1.2 | "再次点击确认删除" |

### 清空历史按钮

| 状态 | background | border | color | size | scale | tooltip |
|------|------------|--------|-------|------|-------|---------|
| **正常** | transparent | none | muted | 16 | 1.0 | "清空历史" |
| **确认** | error-bg | red | red | 18 | 1.1 | "再次点击确认清空" |

## CSS过渡效果

所有动效使用统一的过渡配置：

```css
transition: all 0.2s ease
```

- **持续时间**：200ms，足够快速但不突兀
- **缓动函数**：ease，自然流畅
- **应用属性**：all，确保所有变化都有动画

## 用户体验优势

### 1. 防误操作
- 需要两次点击才能执行危险操作
- 第一次点击后有明显的视觉反馈
- 可以随时取消（点击外部）

### 2. 无打断
- 不使用弹窗，不阻断用户流程
- 动效在原位置展示，不需要移动视线
- 快速响应，流畅自然

### 3. 清晰反馈
- 颜色变化：红色表示危险操作
- 大小变化：放大表示"注意"
- 文字提示：tooltip明确说明

### 4. 快速恢复
- 点击外部立即取消
- 不需要寻找"取消"按钮
- 符合直觉的交互方式

## 边界情况处理

### 1. 删除唯一Session
```typescript
if (sessions.length <= 1) {
    // 删除后自动创建新session
    const newSession: Session = { /* ... */ };
    setSessions([newSession]);
    // ...
}
```

### 2. 多个Session同时进入确认状态
- 使用`deletingSessionId`记录，只能有一个session处于确认状态
- 点击另一个session的删除按钮会自动取消之前的确认状态

### 3. 快速连续点击
- 第一次点击进入确认状态
- 第二次点击立即执行删除
- 不会因为动画未完成而失效

## 可访问性考虑

### 1. Tooltip提示
- 正常状态：明确说明功能
- 确认状态：提示"再次点击确认"

### 2. 视觉对比度
- 使用CSS变量，适应主题色
- 红色警告色，符合通用认知
- 大小变化明显，易于识别

### 3. 键盘支持
- 保持原有的键盘导航能力
- 点击外部取消，也可用ESC键取消（通过外部点击逻辑实现）

## 完成状态

✅ 删除session添加动效确认  
✅ 清空历史添加动效确认  
✅ 点击外部取消确认状态  
✅ 视觉反馈清晰明确  
✅ 过渡动画流畅自然  
✅ 代码已通过linter检查  
✅ 项目构建成功  

## 未来改进方向

### 1. 声音反馈（可选）
- 进入确认状态时播放提示音
- 执行操作时播放确认音

### 2. 倒计时自动取消（可选）
- 进入确认状态后3秒自动取消
- 显示倒计时进度条

### 3. 撤销功能（可选）
- 执行删除后显示"撤销"按钮
- 3秒内可以撤销操作


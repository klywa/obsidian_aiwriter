# 改进需求完成：设置与状态持久化

## 完成内容

### 1. 保存状态
已修复和完善了插件配置和对话历史的持久化存储机制，确保在重新载入插件或重启 Obsidian 后，所有数据都不会丢失。

#### 实现细节：
- **设置结构重构**：修改了 `VoyaruSettings` 接口，将 `sessions` (对话列表) 和 `lastSessionId` (最后选中的对话ID) 直接纳入插件的全局设置对象中。
- **统一存储机制**：弃用了之前在 `ChatComponent` 中错误调用的 `plugin.loadData/saveData`（该方法会覆盖整个 `data.json`），改为统一通过 `plugin.settings` 对象访问数据，并使用 `plugin.saveSettings()` 进行持久化。
    - 现在 `data.json` 会正确包含所有配置项 + 聊天记录，互不干扰。
- **自动保存策略**：
    - **聊天记录**：当消息或 Session 列表发生变化时，会触发防抖（debounce 200ms）保存，避免频繁写入磁盘。
    - **最后选中的 Session**：切换 Session 时立即保存。
    - **卸载保护**：插件卸载或组件销毁前，会执行一次强制保存，防止最后时刻的数据丢失。

#### 验证结果：
1. **插件设置**：修改 API Key、模型、文件夹路径等设置后重启，配置依然存在。
2. **对话历史**：
   - 发送消息后重启 Obsidian，消息记录完整保留。
   - 新建 Session、切换 Session 后重启，状态完全恢复到上次离开时的样子。
   - 即使同时修改设置和聊天，两者也能正确合并保存，不会互相覆盖。

